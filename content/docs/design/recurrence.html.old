<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="/images/favicon.ico">

    <title>Taskwarrior - Recurrence</title>

    <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/site.css" rel="stylesheet">
    <link href="/docs/docs.css" rel="stylesheet">

    <!--[if lt IE 9]><script src="/bootstrap/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
    <div class="navbar navbar-default navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <a class="navbar-brand text-heavy" href="/"><img src="/images/tw-s.png" width="24" height="24"> TASKWARRIOR</a>
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a href="/news/">News</a></li>
            <li class="active"><a href="/docs/">Docs</a></li>
            <li><a href="/download/">Download</a></li>
            <li><a href="/support/">Support</a></li>
            <li><a href="/tools/">Tools</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="col-md-10">
        <div class="col-md-2">
        </div>

        <div class="col-md-10 main">
          <div class="row">
            <div class="callout callout-danger">
              <h3>Draft</h3>
              <p>
                This is a draft design document. Your
                <a href="mailto:support@taskwarrior.org?Subject=Feedback">feedback</a>
                is welcomed.
              </p>
            </div>

            <a name="recurrence"></a>
            <h2>Recurrence</h2>
            <p>
              Recurrence needs an overhaul to improve weaknesses and add new
              features.
            <p>

            <a name="terms"></a>
            <h3>Terminology</h3>
            <p>
              <ul>
                <li>
                  The hidden 'parent' task is called the template.
                </li>
                <li>
                  Synthesis is the name for the generation of new recurring task
                  instances when necessary.
                </li>
                <li>
                  The synthesized tasks are called instances.
                </li>
                <li>
                  The index is the zero-based monotonically increasing number of
                  the instance.
                </li>
                <li>
                  Drift is the accumulated errors in time that cause a due date
                  to slowly change for each recurring task.
                </li>
              </ul>
            </p>

            <a name="critique"></a>
            <h3>Criticism of Current Implementation</h3>
            <p>
              <ul>
                <li>
                  The <code>mask</code> attribute grows unbounded.
                </li>
                <li>
                  Only strict recurrence cycles are supported. The example of
                  mowing the lawn is that you want to mow the lawn every seven
                  days, but when you are four days late mowing the lawn, the
                  next mowing should be in seven days, not in three.
                </li>
                <li>
                  Intances generated on one machine and then synced, may
                  collide with equivalent unsynced instances tasks on another
                  device, because the UUIDs are different.
                </li>
                <li>
                  You cannot <code>wait</code> a recurring task and have that
                  wait period propagate to all other child tasks.
                </li>
                <li>
                  Task instances cannot individually expire.
                </li>
              </ul>
            </p>

            <a name="proposals"></a>
            <h3>Proposals</h3>

              <a name="eliminate-mask-imask"></a>
              <h4>Proposal: Eliminate <code>mask</code>, <code>ima—ïk</code> Attributes</h4>
              <p>
                The <code>mask</code> attribute in the template is replaced by
                <code>last</code>, which indicates the most recent instance index
                synthesized.

                Because instances are never synthesized out of order, we only
                need to store the most recent index.

                The <code>imask</code> attribute in the instance is no longer
                needed.
              </p>

              <a name="rename-parent-template"></a>
              <h4>Proposal: Rename <code>parent</code> to <code>template</code></h4>
              <p>
                The name <code>parent</code> implies subtasks, and confuses those
                who inspect the internals. The value remains the UUID of the
                template. This frees up the namespace for future use with subtasks.
              </p>

              <a name="new-rtype-attribute"></a>
              <h4>Proposal: New 'rtype' attribute</h4>
              <p>
                To indicate the flavor of recurrence, support the following values:

                <table class="table table-condensed">
                  <tr>
                    <td><code>periodic</code></td>
                    <td>
                      Instances are created on a regular schedule.
                      Example: send birthday flowers.  It must occur on a regular
                      schedule, and doesn't matter if you were late last year.
                      This is the default value.
                    </td>
                  </tr>
                  <tr>
                    <td><code>chained</code></td>
                    <td>
                      Instances are created back to back, so when one instance ends,
                      the next begins, with the same recurrence.
                      Example: mow the lawn.  If you mow two days late, the next
                      instance is not two days early to compensate.
                    </td>
                  </tr>
                </table>
              </p>

              <a name="use-relative-offsets"></a>
              <h4>Proposal: Use relative offsets</h4>
              <p>
                The delta between <code>wait</code> and <code>due</code> date in
                the template should be reflected in the delta between
                <code>wait</code> and <code>due</code> date in the instance.

                Similarly, 'scheduled' must be handled the same way.
              </p>

              <a name="auto-upgrade"></a>
              <h4>Proposal: On load, auto-upgrade legacy tasks</h4>
              <p>
                Upgrade template:
                <ul>
                  <li>Add <code>rtype:periodic</code></li>
                  <li>Add <code>last:N</code> where <code>N</code> is the length of <code>mask</code></li>
                  <li>Delete <code>mask</code></li>
                </ul>

                Upgrade instance:
                <ul>
                  <li>Rename <code>parent</code> to <code>template</code></li>
                  <li>Delete <code>imask</code></li>
                  <li>Update <code>wait</code> if not set to: <code>wait:due + (template.due - template.wait)</code></li>
                  <li>Update <code>scheduled</code> if not set to: <code>scheduled:due + (template.due - template.scheduled)</code></li>
                </ul>
              </p>

              <a name="delete-chained"></a>
              <h4>Proposal: Deleting a chained instance</h4>
              <p>
                Deleting a <code>rtype:chained</code> instance causes the next
                chained instance to be synthesized.

                This gives the illusion that the due date is simply pushed out to
                <code>(now + template.recur)</code>.
              </p>

              <a name="modification-propagation"></a>
              <h4>Proposal: Modification Propagation</h4>
              <p>
                TBD
              </p>

              <a name="exotic-dates"></a>
              <h4>Proposal: Exotic Dates</h4>
              <p>
                Expand date specifications to use pattern phrases:
                <ul>
                  <li><code>4th thursday in November</code></li>
                  <li><code>4th thursday of November</code></li>
                  <li><code>Friday before easter</code></li>
                  <li><code>next Tuesday</code></li>
                  <li><code>last Tuesday</code></li>
                  <li><code>last July</code></li>
                  <li><code>weekend</code></li>
                  <li><code>3 days before eom</code></li>
                  <li><code>in the morning</code></li>
                  <li><code>4pm</code></li>
                  <li><code>noon</code></li>
                  <li><code>midnight</code></li>
                </ul>

                Got suggestions?
              </p>

              <h4>Proposal: User-Defined Week Start</h4>
              <p>
                TBD
              </p>

            <a name="implementation"></a>
            <h3>Implementation</h3>

              <a name="add-periodic-template"></a>
              <h4>Implementation: Adding a new <code>periodic</code> template</h4>
              <p>
                When adding a new periodic template:

                <pre>task add ... due:D recur:R wait:D-1wk scheduled:D-1wk until:U</pre>

                Creates:
                <pre>template.uuid:        NEW_UUID
template.description: ...
template.entry:       now
template.modified:    now
template.due:         D
template.recur:       R       (stored in raw form, ie 'P14D')
template.wait:        D-1wk
template.scheduled:   D-1wk
template.until:       U
template.rtype:       periodic
template.last:</pre>

                Creating the Nth instance (index N):

                <pre>Clone instance from template.

instance.uuid:        NEW_UUID
instance.modified:    now
instance.due:         template.due + (N * template.recur)
instance.wait:        instance.due + (template.due - template.wait)
instance.scheduled:   instance.due + (template.due - template.scheduled)
instance.start:

template.last:        N</pre>
              </p>

              <a name="add-chained-template"></a>
              <h4>Implementation: Adding a new <code>chained</code> template</h4>
              <p>
                When adding a new chained template:

                <pre>task add ... due:D recur:R wait:D-1wk scheduled:D-1wk until:U rtype:chained</pre>

                Creates:
                <pre>template.uuid:        NEW_UUID
template.description: ...
template.entry:       now
template.modified:    now
template.due:         D
template.recur:       R       (stored in raw form, ie 'P14D')
template.wait:        D-1wk
template.scheduled:   D-1wk
template.until:       U
template.rtype:       chained</pre>

                Creating the Nth instance (index N):
                <pre>Clone instance from template.

instance.uui  d:        NEW_UUID
instance.mod  ified:    now
instance.due  :         instance[N-1].end + template.recur
instance.wai  t:        instance.due + (template.due - template.wait)
instance.sch  eduled:   instance.due + (template.due - template.scheduled)
instance.sta  rt:</pre>

                Chained tasks do not obey <code>rc.recurrence.limit</code>, and
                show only one pending task at a time.
              </p>

              <a name="special-month-handling"></a>
              <h4>Implementation: Special handling for months</h4>
              <p>
                Certain recurrence periods are inexact:
                <ul>
                  <li>P1M</li>
                  <li>P1Y</li>
                  <li>P1D</li>
                </ul>

                When the recurrence period is <code>P1M</code> the number of days
                in a month varies and causes drift.
              </p>

              <p>
                When the recurrence period is <code>P1Y</code> the number of days
                in a year varies and causes drift.
              </p>

              <p>
                When the recurrence period is <code>P1D</code> the number of hours
                in a day varies due to daylight savings, and causes drift.
              </p>

              <p>
                Drift should be avoided by carefully implementing:

                <pre>instance.due: template.due + (N * template.recur)</pre>
              </p>
          </div>

          <br />
          <br />
        </div>
      </div>

      <div class="col-md-2">
        <div class="alert alert-warning">
          <ul class="list-unstyled">
            <li><a class="alert-link" href="#recurrence">Recurrence</a></li>
            <li><a class="alert-link" href="#terms">Terminology</a></li>
            <li><a class="alert-link" href="#critique">Critique</a></li>
            <li><a class="alert-link" href="#proposals">Proposals</a>
              <ul>
                <li><a class="alert-link" href="#eliminate-mask-imask">Eliminate <code>mask</code>, <code>ima—ïk</code> Attributes</a></li>
                <li><a class="alert-link" href="#rename-parent-template">Rename <code>parent</code> to <code>template</code></a></li>
                <li><a class="alert-link" href="#new-rtype-attribute">New 'rtype' attribute</a></li>
                <li><a class="alert-link" href="#use-relative-offsets">Use relative offsets</a></li>
                <li><a class="alert-link" href="#auto-upgrade">On load, auto-upgrade legacy tasks</a></li>
                <li><a class="alert-link" href="#delete-chained">Deleting a chained instance</a></li>
                <li><a class="alert-link" href="#modification-propagation">Modification Propagation</a></li>
                <li><a class="alert-link" href="#exotic-dates">Exotic Dates</a></li>
              </ul></li>
            <li><a class="alert-link" href="#implementation">Implementation</a>
              <ul>
                <li><a class="alert-link" href="#add-periodic-template">Adding a new <code>periodic</code> template</a></li>
                <li><a class="alert-link" href="#add-chained-template">Adding a new <code>chained</code> template</a></li>
                <li><a class="alert-link" href="#special-month-handling">Special handling for months</a></li>
              </ul></li>
          </ul>
        </div>
      </div>
    </div>

    <div id="footer">
      <div class="container">
        <div class="col-md-2">
          <p class="text-muted">
            Get Involved
            <br />
            <a href="https://github.com/GothenburgBitFactory/taskwarrior/issues">Submit a bug</a>
            <br />
            <a href="https://github.com/GothenburgBitFactory/taskwarrior">Clone the code</a>
          </p>
        </div>
        <div class="col-md-2">
          <p class="text-muted">
            Related Sites
            <br />
            <a href="https://gothenburgbitfactory.org">gothenburgbitfactory.org</a>
            <br />
            <a href="https://holidata.net">holidata.net</a>
          </p>
        </div>
        <div class="col-md-2">
          <p class="text-muted">
            Contact
            <br />
            <a href="mailto:support@taskwarrior.org"><span class="glyphicon glyphicon-envelope"></span> Email</a>
            <br />
            <a href="https://twitter.com/taskwarrior"><img src="/images/twitter_dark.png" width="16px" height="16px"> Twitter</a>
          </p>
        </div>
        <div class="col-md-2">
          <p class="text-muted">
            Donate
            <br />
            <a href="https://github.com/sponsors/GothenburgBitFactory">Sponsor us on Github sponsors!</a>
          </p>
        </div>
        <div class="col-md-2">
          <p class="text-muted">
            Copyright &copy: 2018 <a href="/about.html">G√∂teborg Bit Factory</a>
          </p>
        </div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>
